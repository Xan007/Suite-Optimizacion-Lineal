<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suite Optimizaci√≥n Lineal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f5f7fa;
            color: #1a1a1a;
            padding: 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-size: 1rem;
            color: #666;
            font-weight: 400;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 900px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid #e8ecf1;
        }

        .card h2 {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #1a1a1a;
        }

        .form-group {
            margin-bottom: 1.2rem;
        }

        label {
            display: block;
            font-size: 0.95rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 0.6rem;
        }

        textarea,
        input[type="file"],
        input[type="text"] {
            width: 100%;
            padding: 0.9rem;
            border: 2px solid #e0e4e8;
            border-radius: 10px;
            font-family: inherit;
            font-size: 0.95rem;
            color: #1a1a1a;
            transition: border-color 0.2s;
        }

        textarea:focus,
        input:focus {
            outline: none;
            border-color: #0066cc;
            background-color: #f8fbff;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 0.9rem 1.8rem;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            background: #0052a3;
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3);
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-group {
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
            margin: 1rem 0;
        }

        .method-btn {
            background: white;
            color: #0066cc;
            border: 2px solid #0066cc;
            padding: 0.7rem 1.4rem;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .method-btn:hover {
            background: #f0f4ff;
        }

        .method-btn.active {
            background: #0066cc;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3);
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1a1a1a;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }

        .result-panel {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid #e8ecf1;
        }

        .model-display {
            background: #f8fbff;
            border-left: 4px solid #0066cc;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
        }

        .model-display .title {
            font-size: 1rem;
            font-weight: 700;
            color: #0066cc;
            margin-bottom: 0.8rem;
        }

        .objective-line {
            font-size: 0.95rem;
            margin: 0.5rem 0;
            color: #1a1a1a;
            font-family: 'Courier New', monospace;
        }

        .constraints-list {
            margin-top: 1rem;
        }

        .constraint-item {
            font-size: 0.9rem;
            padding: 0.5rem 0;
            color: #1a1a1a;
            font-family: 'Courier New', monospace;
        }

        .solver-result {
            margin-top: 1.5rem;
        }

        .result-card {
            background: #f0f4ff;
            border: 1px solid #d0deff;
            border-radius: 10px;
            padding: 1.2rem;
            margin-bottom: 1rem;
        }

        .result-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #0066cc;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.4rem;
        }

        .result-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1a1a1a;
            font-family: 'Courier New', monospace;
        }

        .step-iteration {
            background: white;
            border: 1px solid #e0e4e8;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 0.8rem;
        }

        .step-header {
            font-weight: 700;
            color: #0066cc;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .step-detail {
            font-size: 0.85rem;
            color: #666;
            margin: 0.3rem 0;
            font-family: 'Courier New', monospace;
        }

        .variables-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .var-item {
            background: #f8fbff;
            border-left: 3px solid #0066cc;
            padding: 1rem;
            border-radius: 8px;
        }

        .var-name {
            font-weight: 600;
            color: #0066cc;
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
        }

        .var-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1a1a1a;
            font-family: 'Courier New', monospace;
        }

        .table-wrapper {
            overflow-x: auto;
            margin: 1rem 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 0.8rem;
            text-align: left;
            font-size: 0.9rem;
        }

        th {
            background: #f0f4ff;
            color: #0066cc;
            font-weight: 700;
            border-bottom: 2px solid #d0deff;
        }

        td {
            border-bottom: 1px solid #e0e4e8;
            color: #1a1a1a;
        }

        tr:hover {
            background: #f8fbff;
        }

        .method-explanation {
            background: #fff8f0;
            border-left: 4px solid #ff9500;
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #333;
            line-height: 1.6;
            margin: 1rem 0;
            white-space: pre-wrap;
        }

        .sensitivity-section {
            background: #f0fff4;
            border-left: 4px solid #00aa44;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .sensitivity-title {
            font-weight: 700;
            color: #00aa44;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .message {
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            font-size: 0.95rem;
        }

        .message.error {
            background: #fff0f0;
            color: #c00;
            border: 1px solid #ffcccc;
        }

        .message.success {
            background: #f0fff4;
            color: #00aa44;
            border: 1px solid #ccffdd;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid #0066cc;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.6s linear infinite;
            vertical-align: middle;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .no-applicable {
            background: #fff0f0;
            border-left: 4px solid #cc0000;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .no-applicable-title {
            font-weight: 700;
            color: #cc0000;
            margin-bottom: 0.5rem;
        }

        .no-applicable-item {
            color: #666;
            margin: 0.4rem 0;
            padding-left: 1rem;
        }

        /* ====================================================================
           ESTILOS PARA AN√ÅLISIS DE SENSIBILIDAD
           ==================================================================== */
        
        .sensitivity-analysis-container {
            margin-top: 2rem;
            padding: 0;
        }

        .sensitivity-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 16px 16px 0 0;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sensitivity-header h3 {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 700;
        }

        .sensitivity-header .icon {
            font-size: 2rem;
        }

        .sensitivity-body {
            background: white;
            border: 2px solid #e0e4e8;
            border-top: none;
            border-radius: 0 0 16px 16px;
            padding: 2rem;
        }

        /* Tabs de navegaci√≥n */
        .sensitivity-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            border-bottom: 2px solid #e0e4e8;
            padding-bottom: 0.5rem;
        }

        .sensitivity-tab {
            padding: 0.8rem 1.2rem;
            border: none;
            background: #f5f7fa;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .sensitivity-tab:hover {
            background: #e8ecf1;
            color: #333;
        }

        .sensitivity-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .sensitivity-panel {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .sensitivity-panel.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Insights pr√°cticos */
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .insight-card {
            background: linear-gradient(135deg, #f8fbff 0%, #f0f4ff 100%);
            border-left: 4px solid #667eea;
            padding: 1rem 1.2rem;
            border-radius: 8px;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .insight-card strong {
            color: #333;
        }

        /* Secci√≥n de teor√≠a expandible */
        .theory-section {
            background: #fffbf0;
            border: 2px solid #ffd700;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .theory-header {
            background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%);
            padding: 1rem 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #333;
            font-weight: 700;
        }

        .theory-header:hover {
            background: linear-gradient(135deg, #ffaa00 0%, #ff8800 100%);
        }

        .theory-toggle {
            font-size: 1.2rem;
            transition: transform 0.3s;
        }

        .theory-toggle.expanded {
            transform: rotate(180deg);
        }

        .theory-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }

        .theory-content.expanded {
            padding: 1.5rem;
            max-height: 2000px;
        }

        .theory-content h4 {
            color: #333;
            margin: 1rem 0 0.5rem 0;
            font-size: 1.1rem;
        }

        .theory-content h4:first-child {
            margin-top: 0;
        }

        .theory-content p, .theory-content li {
            color: #555;
            line-height: 1.7;
            margin: 0.5rem 0;
        }

        .theory-content ul {
            padding-left: 1.5rem;
        }

        /* Tabla de rangos */
        .sensitivity-table-container {
            overflow-x: auto;
            margin: 1rem 0;
            border-radius: 12px;
            border: 1px solid #e0e4e8;
        }

        .sensitivity-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .sensitivity-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 0.8rem;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
        }

        .sensitivity-table td {
            padding: 0.8rem;
            border-bottom: 1px solid #e0e4e8;
            vertical-align: top;
        }

        .sensitivity-table tr:hover {
            background: #f8fbff;
        }

        .sensitivity-table tr:last-child td {
            border-bottom: none;
        }

        .range-bar-container {
            width: 100%;
            min-width: 150px;
            height: 24px;
            background: #e0e4e8;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }

        .range-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            position: absolute;
        }

        .range-marker {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 12px;
            height: 12px;
            background: #ff6b35;
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 2;
        }

        .range-label {
            font-size: 0.75rem;
            color: #666;
            text-align: center;
            margin-top: 4px;
        }

        /* Precios sombra */
        .shadow-price-card {
            background: white;
            border: 2px solid #e0e4e8;
            border-radius: 12px;
            padding: 1.2rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .shadow-price-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .shadow-price-card.binding {
            border-left: 4px solid #00aa44;
        }

        .shadow-price-card.non-binding {
            border-left: 4px solid #999;
        }

        .shadow-price-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
        }

        .shadow-price-name {
            font-weight: 700;
            color: #333;
            font-size: 1rem;
        }

        .shadow-price-value {
            font-family: 'Courier New', monospace;
            font-size: 1.3rem;
            font-weight: 700;
            color: #667eea;
        }

        .shadow-price-badge {
            display: inline-block;
            padding: 0.25rem 0.6rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .shadow-price-badge.binding {
            background: #d4edda;
            color: #155724;
        }

        .shadow-price-badge.non-binding {
            background: #e2e3e5;
            color: #383d41;
        }

        .shadow-price-explanation {
            color: #555;
            font-size: 0.9rem;
            line-height: 1.5;
            margin-top: 0.8rem;
            padding-top: 0.8rem;
            border-top: 1px solid #e0e4e8;
        }

        .economic-interpretation {
            background: #f0fff4;
            border-radius: 8px;
            padding: 0.8rem;
            margin-top: 0.8rem;
            font-size: 0.85rem;
            color: #00aa44;
        }

        .economic-interpretation::before {
            content: "üí° ";
        }

        /* Costos reducidos */
        .reduced-cost-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .reduced-cost-card {
            background: white;
            border: 2px solid #e0e4e8;
            border-radius: 10px;
            padding: 1rem;
            transition: all 0.2s;
        }

        .reduced-cost-card:hover {
            border-color: #667eea;
        }

        .reduced-cost-card.basic {
            background: linear-gradient(135deg, #f0fff4 0%, #e8f5e9 100%);
            border-color: #4caf50;
        }

        .reduced-cost-card.non-basic {
            background: linear-gradient(135deg, #fff8f0 0%, #fff3e0 100%);
            border-color: #ff9800;
        }

        .reduced-cost-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .reduced-cost-var {
            font-weight: 700;
            color: #333;
            font-size: 1.1rem;
        }

        .reduced-cost-value {
            font-family: 'Courier New', monospace;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .reduced-cost-value.zero {
            color: #4caf50;
        }

        .reduced-cost-value.nonzero {
            color: #ff9800;
        }

        .reduced-cost-status {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .reduced-cost-interpretation {
            font-size: 0.85rem;
            color: #555;
            line-height: 1.4;
        }

        /* Tooltips */
        .tooltip-trigger {
            cursor: help;
            border-bottom: 1px dashed #999;
        }

        /* Tableau final compacto */
        .final-tableau-container {
            margin-top: 1.5rem;
        }

        .final-tableau-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .final-tableau-title {
            font-weight: 700;
            color: #333;
            font-size: 1.1rem;
        }

        .final-tableau-toggle {
            background: #f5f7fa;
            border: 1px solid #e0e4e8;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .final-tableau-toggle:hover {
            background: #e8ecf1;
        }
    </style>
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            options: { skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'] }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>
    <!-- Chart.js para gr√°ficos (reemplaza Plotly) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>

<body>
    <header>
        <h1>Suite Optimizaci√≥n Lineal</h1>
        <p class="subtitle">An√°lisis y resoluci√≥n de problemas de programaci√≥n lineal</p>
    </header>

    <div class="container">
        <div class="two-column">
            <!-- INPUT SECTION -->
            <div class="card">
                <h2>üìù Ingresar Problema</h2>

                <div class="form-group">
                    <label>Descripci√≥n (Texto)</label>
                    <textarea id="problem-text"
                        placeholder="Ejemplo: Maximizar 3x + 2y sujeto a: x + y ‚â§ 4; x ‚â§ 3; x,y ‚â• 0"></textarea>
                    <button onclick="analyzeText()" style="margin-top: 0.8rem; width: 100%;">Analizar Problema</button>
                </div>

                <div style="text-align: center; color: #ccc; margin: 1.5rem 0;">o</div>

                <div class="form-group">
                    <label>An√°lisis desde Imagen</label>
                    <input type="file" id="image-file" accept="image/*">
                    <textarea id="image-description" placeholder="Descripci√≥n adicional (opcional)"
                        style="margin-top: 0.8rem; height: 80px;"></textarea>
                    <button onclick="analyzeImage()" style="margin-top: 0.8rem; width: 100%;">Analizar Imagen</button>
                </div>

                <div id="message" style="margin-top: 1rem;"></div>
            </div>

            <!-- RESULT SECTION -->
            <div class="result-panel">
                <h2>üìä Modelo Can√≥nico</h2>
                <div id="model-display">
                    <p style="color: #999; font-style: italic;">Aqu√≠ aparecer√° el modelo despu√©s del an√°lisis...</p>
                </div>

                <div class="section-title">M√©todos Disponibles</div>
                <div id="methods-container">
                    <p style="color: #999; font-size: 0.9rem;">Selecciona un m√©todo despu√©s de analizar el problema</p>
                </div>

                <div id="not-applicable-methods" style="margin-top: 1rem;"></div>

                <button id="solve-btn" onclick="solveProblem()" style="width: 100%; margin-top: 1.5rem; display: none;">
                    ‚ñ∂ Ejecutar M√©todo Seleccionado
                </button>
            </div>
        </div>

        <!-- SOLUTION SECTION -->
        <div id="solution-section" style="display: none;">
            <div class="result-panel">
                <h2>üéØ Soluci√≥n</h2>
                <div id="solution-content"></div>
            </div>
        </div>
    </div>

    <script>
        // ====================================================================
        // CONFIGURACI√ìN GLOBAL
        // ====================================================================
        const apiBase = '/api/v1';
        let lastAnalysis = null;
        let selectedMethod = null;

        // ====================================================================
        // AN√ÅLISIS: Entrada de datos (texto e imagen)
        // ====================================================================
        async function analyzeText() {
            const text = document.getElementById('problem-text').value;
            if (!text.trim()) {
                showMessage('Por favor ingresa una descripci√≥n del problema', 'error');
                return;
            }
            await analyze({ problem: text });
        }

        async function analyzeImage() {
            const file = document.getElementById('image-file').files[0];
            if (!file) {
                showMessage('Por favor selecciona una imagen', 'error');
                return;
            }
            const formData = new FormData();
            formData.append('file', file);
            const desc = document.getElementById('image-description').value;
            if (desc) formData.append('problem_description', desc);

            try {
                showMessage('Analizando imagen...', 'processing');
                const resp = await fetch(`${apiBase}/analyze/analyze-image`, { method: 'POST', body: formData });
                if (!resp.ok) {
                    const err = await resp.json();
                    showMessage(err.detail || 'Error al analizar imagen', 'error');
                    return;
                }
                const json = await resp.json();
                handleAnalysisResponse(json);
            } catch (e) {
                showMessage(`Error: ${e.message}`, 'error');
            }
        }

        async function analyze(payload) {
            try {
                showMessage('Analizando problema...', 'processing');
                const resp = await fetch(`${apiBase}/analyze/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!resp.ok) {
                    const err = await resp.json();
                    showMessage(err.detail || 'Error en an√°lisis', 'error');
                    return;
                }
                const json = await resp.json();
                handleAnalysisResponse(json);
            } catch (e) {
                showMessage(`Error: ${e.message}`, 'error');
            }
        }

        // ====================================================================
        // AN√ÅLISIS: Procesamiento de respuesta
        // ====================================================================
        function handleAnalysisResponse(json) {
            lastAnalysis = json;
            showMessage('‚úì An√°lisis completado', 'success');

            // Mostrar modelo
            const model = json.mathematical_model || (json.result && json.result.mathematical_model);
            if (model) {
                displayModel(model);
            }

            // Mostrar m√©todos
            const suggested = json.suggested_methods || (json.result && json.result.suggested_methods) || [];
            const notApplicable = json.methods_not_applicable || (json.result && json.result.methods_not_applicable) || {};

            const methodsContainer = document.getElementById('methods-container');
            methodsContainer.innerHTML = '';

            // Mapa de nombres de m√©todos en espa√±ol
            const methodDisplayNames = {
                'simplex': 'Simplex',
                'dual_simplex': 'Simplex Dual',
                'graphical': 'Gr√°fico',
                'big_m': 'Gran M',
                'interior_point': 'Punto Interior'
            };

            if (suggested.length > 0) {
                const btnGroup = document.createElement('div');
                btnGroup.className = 'btn-group';
                suggested.forEach(m => {
                    const btn = document.createElement('button');
                    btn.className = 'method-btn';
                    btn.textContent = methodDisplayNames[m] || m.charAt(0).toUpperCase() + m.slice(1);
                    btn.onclick = () => selectMethod(m, btn);
                    btnGroup.appendChild(btn);
                });
                methodsContainer.appendChild(btnGroup);
            }

            // Limpiar siempre el contenedor de m√©todos no aplicables
            document.getElementById('not-applicable-methods').innerHTML = '';
            
            // Solo mostrar si hay m√©todos no aplicables
            if (Object.keys(notApplicable).length > 0) {
                const notAppDiv = document.createElement('div');
                notAppDiv.className = 'no-applicable';
                const title = document.createElement('div');
                title.className = 'no-applicable-title';
                title.textContent = '‚úó M√©todos no aplicables:';
                notAppDiv.appendChild(title);
                for (const [method, reason] of Object.entries(notApplicable)) {
                    const item = document.createElement('div');
                    item.className = 'no-applicable-item';
                    const displayName = methodDisplayNames[method] || method;
                    item.textContent = `${displayName}: ${reason}`;
                    notAppDiv.appendChild(item);
                }
                document.getElementById('not-applicable-methods').appendChild(notAppDiv);
            }

            document.getElementById('solve-btn').style.display = 'none';
        }

        // ====================================================================
        // M√âTODO: Selecci√≥n y ejecuci√≥n
        // ====================================================================
        function selectMethod(method, btnElement) {
            selectedMethod = method;
            document.querySelectorAll('.method-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');
            document.getElementById('solve-btn').style.display = 'block';
        }

        // ====================================================================
        // VISUALIZACI√ìN: Modelo matem√°tico
        // ====================================================================
        function displayModel(model) {
            const div = document.createElement('div');
            div.className = 'model-display';

            const title = document.createElement('div');
            title.className = 'title';
            title.textContent = (model.objective === 'min' ? 'üìâ Minimizar' : 'üìà Maximizar');
            div.appendChild(title);

            // Mostrar funci√≥n objetivo en LaTeX si est√° disponible
            const objLine = document.createElement('div');
            objLine.className = 'objective-line';
            const objText = model.objective_function_latex || model.objective_function;
            objLine.innerHTML = `$$${objText}$$`;
            div.appendChild(objLine);

            if (model.constraints && model.constraints.length > 0) {
                const consTitle = document.createElement('div');
                consTitle.style.fontWeight = '600';
                consTitle.style.color = '#1a1a1a';
                consTitle.style.marginTop = '1rem';
                consTitle.textContent = 'Sujeto a:';
                div.appendChild(consTitle);

                const consList = document.createElement('div');
                consList.className = 'constraints-list';
                if (model.constraints_latex && model.constraints_latex.length > 0) {
                    model.constraints_latex.forEach((c, idx) => {
                        const item = document.createElement('div');
                        item.className = 'constraint-item';
                        item.innerHTML = `$$${c}$$`;
                        consList.appendChild(item);
                    });
                } else {
                    model.constraints.forEach(c => {
                        const item = document.createElement('div');
                        item.className = 'constraint-item';
                        item.innerHTML = `$$${c}$$`;
                        consList.appendChild(item);
                    });
                }
                div.appendChild(consList);
            }

            // No-negatividad en LaTeX
            if (model.non_negativity_latex && model.non_negativity_latex.length > 0) {
                const nonnegTitle = document.createElement('div');
                nonnegTitle.style.fontWeight = '600';
                nonnegTitle.style.color = '#1a1a1a';
                nonnegTitle.style.marginTop = '0.8rem';
                nonnegTitle.style.fontSize = '0.9rem';
                nonnegTitle.textContent = 'No-negatividad:';
                div.appendChild(nonnegTitle);

                const nonnegList = document.createElement('div');
                nonnegList.className = 'constraints-list';
                model.non_negativity_latex.forEach(c => {
                    const item = document.createElement('div');
                    item.className = 'constraint-item';
                    item.style.fontSize = '0.85rem';
                    item.innerHTML = `$$${c}$$`;
                    nonnegList.appendChild(item);
                });
                div.appendChild(nonnegList);
            }

            document.getElementById('model-display').innerHTML = '';
            document.getElementById('model-display').appendChild(div);

            // Renderizar MathJax despu√©s de insertar el contenido
            if (window.MathJax) {
                MathJax.contentDocument = document;
                MathJax.typesetPromise([div]).catch(err => console.error('MathJax error:', err));
            }
        }

        async function solveProblem() {
            if (!lastAnalysis) {
                showMessage('Por favor analiza un problema primero', 'error');
                return;
            }
            if (!selectedMethod) {
                showMessage('Por favor selecciona un m√©todo', 'error');
                return;
            }

            const model = lastAnalysis.mathematical_model || (lastAnalysis.result && lastAnalysis.result.mathematical_model);
            if (!model) {
                showMessage('Error: no se encontr√≥ el modelo', 'error');
                return;
            }

            try {
                showMessage('Resolviendo...', 'processing');
                const payload = { model, method: selectedMethod };
                const resp = await fetch(`${apiBase}/analyze/solve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!resp.ok) {
                    const err = await resp.json();
                    showMessage(err.detail || 'Error al resolver', 'error');
                    return;
                }

                const json = await resp.json();
                if (json.result) {
                    displaySolution(json.result);
                    if (json.result.success === false) {
                        showMessage(json.result.error || 'Error al resolver', 'error');
                    } else {
                        showMessage('‚úì Problema resuelto exitosamente', 'success');
                    }
                }
            } catch (e) {
                showMessage(`Error: ${e.message}`, 'error');
            }
        }

        // ====================================================================
        // SOLUCI√ìN: Visualizaci√≥n de resultados
        // ====================================================================
        function displaySolution(result) {
            console.log('displaySolution called with result:', result);
            // If solver returned an error, show it and skip rendering
            if (result && result.success === false) {
                showMessage(result.error || 'Error al resolver el problema', 'error');
                return;
            }
            document.getElementById('solution-section').style.display = 'block';
            const content = document.getElementById('solution-content');
            content.innerHTML = '';

            // Limpiar gr√°ficas previas de Plotly
            const existingPlot = document.getElementById('graphical-plot');
            if (existingPlot) existingPlot.remove();

            // Mapa de nombres de m√©todos en espa√±ol (para la secci√≥n de soluci√≥n)
            const methodDisplayNamesResult = {
                'simplex': 'Simplex',
                'dual_simplex': 'Simplex Dual',
                'graphical': 'Gr√°fico',
                'big_m': 'Gran M',
                'interior_point': 'Punto Interior'
            };

            // M√©todo
            const methodDiv = document.createElement('div');
            methodDiv.style.marginBottom = '1.5rem';
            const methodLabel = document.createElement('div');
            methodLabel.style.fontSize = '0.9rem';
            methodLabel.style.color = '#0066cc';
            methodLabel.style.fontWeight = '600';
            methodLabel.style.marginBottom = '0.3rem';
            methodLabel.textContent = 'M√âTODO USADO';
            methodDiv.appendChild(methodLabel);
            const methodName = document.createElement('div');
            methodName.style.fontSize = '1.4rem';
            methodName.style.fontWeight = '700';
            methodName.style.color = '#1a1a1a';
            methodName.textContent = result.method ? (methodDisplayNamesResult[result.method] || result.method).toUpperCase() : 'RESULTADO';
            methodDiv.appendChild(methodName);
            content.appendChild(methodDiv);

            // Objetivo
            if (result.objective_value !== undefined) {
                const objDiv = document.createElement('div');
                objDiv.className = 'result-card';
                const label = document.createElement('div');
                label.className = 'result-label';
                label.textContent = 'Valor √ìptimo';
                objDiv.appendChild(label);
                const val = document.createElement('div');
                val.className = 'result-value';
                val.textContent = formatNumber(result.objective_value, 6);
                objDiv.appendChild(val);
                content.appendChild(objDiv);
                console.log('Rendered objective value:', result.objective_value);
            } else {
                console.warn('No objective_value in result');
            }

            // ===== MOSTRAR ECUACIONES LaTeX CON VARIABLES DE HOLGURA =====
            if ((result.method === 'simplex' || result.method === 'dual_simplex' || result.method === 'big_m') 
                && result.equations_latex && result.equations_latex.trim().length > 0) {
                const eqTitle = document.createElement('div');
                eqTitle.className = 'section-title';
                // T√≠tulo seg√∫n el m√©todo
                if (result.method === 'big_m') {
                    eqTitle.textContent = 'Ecuaciones con Variables de Holgura y Artificiales';
                } else {
                    eqTitle.textContent = 'Ecuaciones con Variables de Holgura';
                }
                content.appendChild(eqTitle);

                const eqDiv = document.createElement('div');
                eqDiv.style.background = '#f8fbff';
                eqDiv.style.border = '2px solid #0066cc';
                eqDiv.style.borderRadius = '10px';
                eqDiv.style.padding = '1.5rem';
                eqDiv.style.marginBottom = '1.5rem';
                eqDiv.style.lineHeight = '2.2';

                eqDiv.innerHTML = result.equations_latex;
                content.appendChild(eqDiv);

                // Renderizar MathJax para las ecuaciones
                if (window.MathJax) {
                    MathJax.contentDocument = document;
                    MathJax.typesetPromise([eqDiv]).catch(err => console.warn('MathJax error:', err));
                }
            }

            // Variables
            if (result.variables && Object.keys(result.variables).length > 0) {
                const varTitle = document.createElement('div');
                varTitle.className = 'section-title';
                varTitle.textContent = 'Valores de Variables';
                content.appendChild(varTitle);

                const varGrid = document.createElement('div');
                varGrid.className = 'variables-grid';
                for (const [name, value] of Object.entries(result.variables)) {
                    const item = document.createElement('div');
                    item.className = 'var-item';
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'var-name';
                    nameDiv.textContent = name;
                    item.appendChild(nameDiv);
                    const valDiv = document.createElement('div');
                    valDiv.className = 'var-value';
                    valDiv.textContent = formatNumber(Number(value), 6);
                    item.appendChild(valDiv);
                    varGrid.appendChild(item);
                }
                content.appendChild(varGrid);
            } else {
                console.warn('No variables in result');
            }

            // Explicaci√≥n
            if (result.explanation) {
                const exTitle = document.createElement('div');
                exTitle.className = 'section-title';
                exTitle.textContent = 'Procedimiento Aplicado';
                content.appendChild(exTitle);

                const exDiv = document.createElement('div');
                exDiv.className = 'method-explanation';
                exDiv.textContent = result.explanation;
                content.appendChild(exDiv);
            }

            // Pasos - renderizado diferente seg√∫n el m√©todo
            if (result.steps && result.steps.length > 0) {
                const stepsTitle = document.createElement('div');
                stepsTitle.className = 'section-title';
                // T√≠tulo diferente seg√∫n el m√©todo
                if (result.method === 'interior_point') {
                    stepsTitle.textContent = `Trayectoria Interior (${result.steps.length} iteraciones)`;
                } else if (result.method === 'graphical') {
                    stepsTitle.textContent = `Evaluaci√≥n de V√©rtices (${result.steps.length})`;
                } else {
                    stepsTitle.textContent = `Iteraciones del M√©todo (${result.steps.length})`;
                }
                content.appendChild(stepsTitle);

                const stepsContainer = document.createElement('div');

                // Para m√©todo de Punto Interior, mostrar visualizaci√≥n especial
                if (result.method === 'interior_point') {
                    result.steps.forEach(step => {
                        const stepCard = document.createElement('div');
                        stepCard.className = 'step-iteration';
                        stepCard.style.marginBottom = '1.5rem';
                        stepCard.style.padding = '1.5rem';
                        stepCard.style.border = step.is_optimal ? '2px solid #28a745' : '1px solid #ddd';
                        stepCard.style.borderRadius = '12px';
                        stepCard.style.backgroundColor = step.is_optimal ? '#f0fff4' : '#ffffff';
                        stepCard.style.boxShadow = '0 2px 8px rgba(0,0,0,0.05)';

                        // Header con iteraci√≥n
                        const header = document.createElement('div');
                        header.style.display = 'flex';
                        header.style.justifyContent = 'space-between';
                        header.style.alignItems = 'center';
                        header.style.marginBottom = '1rem';
                        header.style.paddingBottom = '0.8rem';
                        header.style.borderBottom = '1px solid #eee';
                        
                        const iterLabel = document.createElement('span');
                        iterLabel.style.fontWeight = '700';
                        iterLabel.style.fontSize = '1.1rem';
                        iterLabel.style.color = step.is_optimal ? '#28a745' : '#0066cc';
                        iterLabel.innerHTML = step.iteration === 0 
                            ? 'üöÄ Punto Inicial' 
                            : `üìç Iteraci√≥n ${step.iteration}`;
                        if (step.is_optimal) {
                            iterLabel.innerHTML += ' <span style="color: #ff6b35;">‚≠ê √ìPTIMO</span>';
                        }
                        header.appendChild(iterLabel);

                        const objBadge = document.createElement('span');
                        objBadge.style.backgroundColor = step.is_optimal ? '#28a745' : '#0066cc';
                        objBadge.style.color = 'white';
                        objBadge.style.padding = '0.3rem 0.8rem';
                        objBadge.style.borderRadius = '20px';
                        objBadge.style.fontSize = '0.9rem';
                        objBadge.style.fontWeight = '600';
                        objBadge.textContent = `Z = ${formatNumber(step.objective_value, 6)}`;
                        header.appendChild(objBadge);
                        stepCard.appendChild(header);

                        // Descripci√≥n
                        const descDiv = document.createElement('div');
                        descDiv.style.marginBottom = '1rem';
                        descDiv.style.padding = '0.8rem';
                        descDiv.style.backgroundColor = '#f8f9fa';
                        descDiv.style.borderRadius = '8px';
                        descDiv.style.fontSize = '0.95rem';
                        descDiv.style.color = '#495057';
                        descDiv.innerHTML = `<strong>üìã</strong> ${step.description}`;
                        stepCard.appendChild(descDiv);

                        // Variables de decisi√≥n en grid
                        if (step.x && step.x.length > 0 && step.var_names) {
                            const varsTitle = document.createElement('div');
                            varsTitle.style.fontWeight = '600';
                            varsTitle.style.marginBottom = '0.5rem';
                            varsTitle.style.color = '#333';
                            varsTitle.textContent = 'üìä Variables de Decisi√≥n:';
                            stepCard.appendChild(varsTitle);

                            const varsGrid = document.createElement('div');
                            varsGrid.style.display = 'grid';
                            varsGrid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(120px, 1fr))';
                            varsGrid.style.gap = '0.5rem';
                            varsGrid.style.marginBottom = '1rem';

                            step.var_names.forEach((name, idx) => {
                                if (idx < step.x.length) {
                                    const varItem = document.createElement('div');
                                    varItem.style.backgroundColor = '#e3f2fd';
                                    varItem.style.padding = '0.5rem 0.8rem';
                                    varItem.style.borderRadius = '6px';
                                    varItem.style.textAlign = 'center';
                                    varItem.innerHTML = `<strong>${name}</strong> = ${formatNumber(step.x[idx], 6)}`;
                                    varsGrid.appendChild(varItem);
                                }
                            });
                            stepCard.appendChild(varsGrid);
                        }

                        // M√©tricas de convergencia (si existen)
                        if (step.mu !== null || step.complementarity_gap !== null || step.alpha !== null || step.slacks !== null) {
                            const metricsDiv = document.createElement('div');
                            metricsDiv.style.display = 'grid';
                            metricsDiv.style.gridTemplateColumns = 'repeat(auto-fit, minmax(180px, 1fr))';
                            metricsDiv.style.gap = '0.8rem';
                            metricsDiv.style.marginTop = '1rem';

                            if (step.mu !== null && step.mu !== undefined) {
                                const muCard = document.createElement('div');
                                muCard.style.backgroundColor = '#fff3e0';
                                muCard.style.padding = '0.8rem';
                                muCard.style.borderRadius = '8px';
                                muCard.style.textAlign = 'center';
                                muCard.innerHTML = `
                                    <div style="font-size: 0.8rem; color: #e65100; font-weight: 600;">Par√°metro Œº (Barrera)</div>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: #bf360c;">${step.mu.toExponential(2)}</div>
                                `;
                                metricsDiv.appendChild(muCard);
                            }

                            if (step.complementarity_gap !== null && step.complementarity_gap !== undefined) {
                                const gapCard = document.createElement('div');
                                gapCard.style.backgroundColor = '#e8f5e9';
                                gapCard.style.padding = '0.8rem';
                                gapCard.style.borderRadius = '8px';
                                gapCard.style.textAlign = 'center';
                                gapCard.innerHTML = `
                                    <div style="font-size: 0.8rem; color: #2e7d32; font-weight: 600;">Gap de Convergencia</div>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: #1b5e20;">${step.complementarity_gap.toExponential(2)}</div>
                                `;
                                metricsDiv.appendChild(gapCard);
                            }

                            if (step.alpha !== null && step.alpha !== undefined) {
                                const alphaCard = document.createElement('div');
                                alphaCard.style.backgroundColor = '#e1f5fe';
                                alphaCard.style.padding = '0.8rem';
                                alphaCard.style.borderRadius = '8px';
                                alphaCard.style.textAlign = 'center';
                                alphaCard.innerHTML = `
                                    <div style="font-size: 0.8rem; color: #0277bd; font-weight: 600;">Tama√±o de Paso</div>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: #01579b;">Œ± = ${formatNumber(step.alpha, 4)}</div>
                                `;
                                metricsDiv.appendChild(alphaCard);
                            }

                            if (step.gradient_norm !== null && step.gradient_norm !== undefined) {
                                const gradCard = document.createElement('div');
                                gradCard.style.backgroundColor = '#f3e5f5';
                                gradCard.style.padding = '0.8rem';
                                gradCard.style.borderRadius = '8px';
                                gradCard.style.textAlign = 'center';
                                gradCard.innerHTML = `
                                    <div style="font-size: 0.8rem; color: #7b1fa2; font-weight: 600;">||Direcci√≥n||</div>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: #4a148c;">${formatNumber(step.gradient_norm, 4)}</div>
                                `;
                                metricsDiv.appendChild(gradCard);
                            }

                            stepCard.appendChild(metricsDiv);
                        }

                        // Mostrar holguras si existen
                        if (step.slacks && step.slacks.length > 0) {
                            const slacksTitle = document.createElement('div');
                            slacksTitle.style.fontWeight = '600';
                            slacksTitle.style.marginTop = '1rem';
                            slacksTitle.style.marginBottom = '0.5rem';
                            slacksTitle.style.color = '#333';
                            slacksTitle.textContent = 'üìè Holguras (distancia al borde):';
                            stepCard.appendChild(slacksTitle);

                            const slacksGrid = document.createElement('div');
                            slacksGrid.style.display = 'flex';
                            slacksGrid.style.flexWrap = 'wrap';
                            slacksGrid.style.gap = '0.5rem';

                            step.slacks.forEach((slack, idx) => {
                                const slackItem = document.createElement('span');
                                slackItem.style.backgroundColor = slack > 0.1 ? '#c8e6c9' : '#ffcdd2';
                                slackItem.style.padding = '0.3rem 0.6rem';
                                slackItem.style.borderRadius = '4px';
                                slackItem.style.fontSize = '0.85rem';
                                slackItem.textContent = `s${idx + 1} = ${formatNumber(slack, 4)}`;
                                slacksGrid.appendChild(slackItem);
                            });
                            stepCard.appendChild(slacksGrid);
                        }

                        stepsContainer.appendChild(stepCard);
                    });
                }
                // Para m√©todo gr√°fico, mostrar de forma simplificada
                else if (result.method === 'graphical') {
                    result.steps.forEach(step => {
                        const stepCard = document.createElement('div');
                        stepCard.className = 'step-iteration';
                        stepCard.style.marginBottom = '1rem';
                        stepCard.style.padding = '1rem';
                        stepCard.style.border = '1px solid #ddd';
                        stepCard.style.borderRadius = '8px';
                        stepCard.style.backgroundColor = step.is_optimal ? '#f0fff0' : '#ffffff';

                        const header = document.createElement('div');
                        header.style.fontWeight = '600';
                        header.style.marginBottom = '0.5rem';
                        header.style.color = step.is_optimal ? '#008000' : '#0066cc';
                        header.innerHTML = `
                            V√©rtice ${step.iteration}: (${step.point[0].toFixed(4)}, ${step.point[1].toFixed(4)})
                            ${step.is_optimal ? '<strong style="color: #ff6b35;"> ‚≠ê √ìPTIMO</strong>' : ''}
                        `;
                        stepCard.appendChild(header);
                        const value = document.createElement('div');
                        value.style.fontSize = '0.95rem';
                        value.textContent = `Valor Objetivo: ${step.objective_value.toFixed(6)}`;
                        stepCard.appendChild(value);

                        stepsContainer.appendChild(stepCard);
                    });
                } else {
                    // Para Simplex y otros m√©todos, mostrar tablas detalladas
                    if (result.steps && Array.isArray(result.steps)) {
                        result.steps.forEach(step => {
                            const stepCard = document.createElement('div');
                            stepCard.className = 'step-iteration';
                            stepCard.style.marginBottom = '2rem';
                            stepCard.style.padding = '1.5rem';
                            stepCard.style.border = '1px solid #ddd';
                            stepCard.style.borderRadius = '8px';

                            // Encabezado de iteraci√≥n
                            const header = document.createElement('div');
                            header.className = 'step-header';
                            header.style.fontSize = '1.1rem';
                            header.style.fontWeight = '700';
                            header.style.marginBottom = '1rem';
                            header.style.color = '#0066cc';
                            header.textContent = `Iteraci√≥n ${step.iteration}`;
                            stepCard.appendChild(header);

                            // Info de pivote
                            if (step.entering_variable && step.leaving_variable) {
                                const pivotInfo = document.createElement('div');
                                pivotInfo.style.marginBottom = '1rem';
                                pivotInfo.style.padding = '0.8rem';
                                pivotInfo.style.backgroundColor = '#f0f4ff';
                                pivotInfo.style.borderRadius = '6px';
                                pivotInfo.innerHTML = `
                                <div style="font-weight: 600; margin-bottom: 0.3rem;">Operaci√≥n Pivote</div>
                                <div>Variable Entrante: <strong>${step.entering_variable}</strong></div>
                                <div>Variable Saliente: <strong>${step.leaving_variable}</strong></div>
                                <div>Elemento Pivote: <strong>${formatNumber(step.pivot_element, 4)}</strong></div>
                                <div>Fila Pivote: ${step.leaving_row}, Columna Pivote: ${step.entering_col}</div>
                            `;
                                stepCard.appendChild(pivotInfo);
                            }

                            // Tabla ANTES
                            if (step.tableau_before) {
                                const beforeTitle = document.createElement('div');
                                beforeTitle.style.fontWeight = '600';
                                beforeTitle.style.marginTop = '1rem';
                                beforeTitle.style.marginBottom = '0.5rem';
                                beforeTitle.textContent = 'Tabla Antes del Pivote:';
                                stepCard.appendChild(beforeTitle);

                                const beforeTable = document.createElement('table');
                                beforeTable.style.width = '100%';
                                beforeTable.style.borderCollapse = 'collapse';
                                beforeTable.style.fontSize = '0.85rem';
                                beforeTable.style.marginBottom = '1rem';
                                beforeTable.style.overflowX = 'auto';
                                beforeTable.style.display = 'block';

                                // Headers
                                const thead = document.createElement('thead');
                                const headerRow = document.createElement('tr');
                                headerRow.style.backgroundColor = '#f5f5f5';

                                const baseHeader = document.createElement('th');
                                baseHeader.textContent = 'Base';
                                baseHeader.style.padding = '0.4rem';
                                baseHeader.style.border = '1px solid #ddd';
                                baseHeader.style.textAlign = 'left';
                                baseHeader.style.backgroundColor = '#4CAF50';
                                baseHeader.style.color = 'white';
                                headerRow.appendChild(baseHeader);

                                // Construir lista de todos los encabezados con sus √≠ndices
                                // Usar column_headers del backend si existen, sino generar autom√°ticamente
                                const allHeaders = [];
                                if (step.column_headers && step.column_headers.length > 0) {
                                    // Usar los headers del backend (excluye RHS que est√° al final)
                                    step.column_headers.forEach((name, idx) => {
                                        if (name !== 'RHS') {
                                            allHeaders.push({name: name, colIdx: idx});
                                        }
                                    });
                                } else {
                                    // Fallback: generar autom√°ticamente
                                    if (step.var_names) {
                                        step.var_names.forEach((v, idx) => allHeaders.push({name: v, colIdx: idx}));
                                    }
                                    const colsToSkip = step.var_names ? step.var_names.length : 0;
                                    const numSlackCols = step.tableau_before[0].length - colsToSkip - 1;
                                    for (let i = 0; i < numSlackCols; i++) {
                                        allHeaders.push({name: `s${i + 1}`, colIdx: colsToSkip + i});
                                    }
                                }
                                
                                // Crear encabezados con colores para columna pivote
                                allHeaders.forEach(({name, colIdx}) => {
                                    const th = document.createElement('th');
                                    th.textContent = name;
                                    th.style.padding = '0.4rem';
                                    th.style.border = '1px solid #ddd';
                                    th.style.textAlign = 'center';
                                    th.style.fontWeight = '600';
                                    // Colorear encabezado de columna pivote
                                    if (colIdx === step.entering_col) {
                                        th.style.backgroundColor = '#6666ff';
                                        th.style.color = 'white';
                                    } else {
                                        th.style.backgroundColor = '#4CAF50';
                                        th.style.color = 'white';
                                    }
                                    headerRow.appendChild(th);
                                });

                                const rhsHeader = document.createElement('th');
                                rhsHeader.textContent = 'RHS';
                                rhsHeader.style.padding = '0.4rem';
                                rhsHeader.style.border = '1px solid #ddd';
                                rhsHeader.style.textAlign = 'center';
                                rhsHeader.style.fontWeight = '600';
                                rhsHeader.style.backgroundColor = '#4CAF50';
                                rhsHeader.style.color = 'white';
                                headerRow.appendChild(rhsHeader);

                                thead.appendChild(headerRow);
                                beforeTable.appendChild(thead);

                                // Body (excluir √∫ltima fila que es la fila Z, se agrega manualmente despu√©s)
                                const tbody = document.createElement('tbody');
                                const dataRowsBefore = step.tableau_before.slice(0, -1); // Excluir fila Z
                                dataRowsBefore.forEach((row, rowIdx) => {
                                    const tr = document.createElement('tr');
                                    // Fila pivote: fondo rosa claro
                                    tr.style.backgroundColor = rowIdx === step.leaving_row ? '#ffe0e0' : '#ffffff';

                                    const baseCell = document.createElement('td');
                                    baseCell.textContent = step.basis_before[rowIdx] || (rowIdx === step.tableau_before.length - 1 ? 'Z' : `R${rowIdx}`);
                                    baseCell.style.padding = '0.4rem';
                                    baseCell.style.border = '1px solid #ddd';
                                    baseCell.style.fontWeight = '600';
                                    baseCell.style.backgroundColor = '#f0f0f0';
                                    tr.appendChild(baseCell);

                                    row.forEach((val, colIdx) => {
                                        const td = document.createElement('td');
                                        td.textContent = formatNumber(val, 4);
                                        td.style.padding = '0.4rem';
                                        td.style.border = '1px solid #ddd';
                                        td.style.textAlign = 'center';
                                        
                                        // Elemento pivote: amarillo intenso con borde rojo
                                        if (rowIdx === step.leaving_row && colIdx === step.entering_col) {
                                            td.style.backgroundColor = '#ff4444';
                                            td.style.color = 'white';
                                            td.style.fontWeight = '700';
                                            td.style.border = '3px solid #cc0000';
                                        }
                                        // Columna pivote (excepto elemento pivote): azul claro
                                        else if (colIdx === step.entering_col) {
                                            td.style.backgroundColor = '#ccccff';
                                        }
                                        // Fila pivote (excepto elemento pivote): rosa claro
                                        else if (rowIdx === step.leaving_row) {
                                            td.style.backgroundColor = '#ffcccc';
                                        }
                                        
                                        tr.appendChild(td);
                                    });
                                    tbody.appendChild(tr);
                                });

                                // Fila de objetivo
                                const objRow = document.createElement('tr');
                                objRow.style.backgroundColor = '#e0e0ff';
                                const objLabel = document.createElement('td');
                                objLabel.textContent = 'Z';
                                objLabel.style.padding = '0.4rem';
                                objLabel.style.border = '1px solid #ddd';
                                objLabel.style.fontWeight = '600';
                                objLabel.style.backgroundColor = '#d0d0ff';
                                objRow.appendChild(objLabel);
                                step.obj_row_before.forEach((val, idx) => {
                                    const td = document.createElement('td');
                                    td.textContent = formatNumber(val, 4);
                                    td.style.padding = '0.4rem';
                                    td.style.border = '1px solid #ddd';
                                    td.style.textAlign = 'center';
                                    // Columna pivote en fila Z: azul claro
                                    if (idx === step.entering_col) {
                                        td.style.backgroundColor = '#ccccff';
                                        td.style.fontWeight = '700';
                                    }
                                    objRow.appendChild(td);
                                });
                                tbody.appendChild(objRow);

                                beforeTable.appendChild(tbody);
                                stepCard.appendChild(beforeTable);
                            }

                            // Tabla DESPU√âS
                            if (step.tableau_after) {
                                const afterTitle = document.createElement('div');
                                afterTitle.style.fontWeight = '600';
                                afterTitle.style.marginTop = '1rem';
                                afterTitle.style.marginBottom = '0.5rem';
                                afterTitle.textContent = 'Tabla Despu√©s del Pivote:';
                                stepCard.appendChild(afterTitle);

                                const afterTable = document.createElement('table');
                                afterTable.style.width = '100%';
                                afterTable.style.borderCollapse = 'collapse';
                                afterTable.style.fontSize = '0.85rem';
                                afterTable.style.display = 'block';
                                afterTable.style.overflowX = 'auto';

                                // Headers
                                const thead = document.createElement('thead');
                                const headerRow = document.createElement('tr');
                                headerRow.style.backgroundColor = '#f5f5f5';

                                const baseHeader = document.createElement('th');
                                baseHeader.textContent = 'Base';
                                baseHeader.style.padding = '0.4rem';
                                baseHeader.style.border = '1px solid #ddd';
                                baseHeader.style.textAlign = 'left';
                                baseHeader.style.backgroundColor = '#4CAF50';
                                baseHeader.style.color = 'white';
                                headerRow.appendChild(baseHeader);

                                // Construir lista de todos los encabezados con sus √≠ndices (para tabla despu√©s)
                                // Usar column_headers del backend si existen
                                const allHeadersAfter = [];
                                if (step.column_headers && step.column_headers.length > 0) {
                                    // Usar los headers del backend (excluye RHS que est√° al final)
                                    step.column_headers.forEach((name, idx) => {
                                        if (name !== 'RHS') {
                                            allHeadersAfter.push({name: name, colIdx: idx});
                                        }
                                    });
                                } else {
                                    // Fallback: generar autom√°ticamente
                                    if (step.var_names) {
                                        step.var_names.forEach((v, idx) => allHeadersAfter.push({name: v, colIdx: idx}));
                                    }
                                    const numSlackColsAfter = step.tableau_after[0].length - (step.var_names ? step.var_names.length : 0) - 1;
                                    for (let i = 0; i < numSlackColsAfter; i++) {
                                        allHeadersAfter.push({name: `s${i + 1}`, colIdx: (step.var_names ? step.var_names.length : 0) + i});
                                    }
                                }
                                
                                // Crear encabezados (sin resaltar columna pivote en tabla despu√©s)
                                allHeadersAfter.forEach(({name, colIdx}) => {
                                    const th = document.createElement('th');
                                    th.textContent = name;
                                    th.style.padding = '0.4rem';
                                    th.style.border = '1px solid #ddd';
                                    th.style.textAlign = 'center';
                                    th.style.fontWeight = '600';
                                    th.style.backgroundColor = '#4CAF50';
                                    th.style.color = 'white';
                                    headerRow.appendChild(th);
                                });

                                const rhsHeader = document.createElement('th');
                                rhsHeader.textContent = 'RHS';
                                rhsHeader.style.padding = '0.4rem';
                                rhsHeader.style.border = '1px solid #ddd';
                                rhsHeader.style.textAlign = 'center';
                                rhsHeader.style.fontWeight = '600';
                                rhsHeader.style.backgroundColor = '#4CAF50';
                                rhsHeader.style.color = 'white';
                                headerRow.appendChild(rhsHeader);

                                thead.appendChild(headerRow);
                                afterTable.appendChild(thead);

                                // Body (excluir √∫ltima fila que es la fila Z, se agrega manualmente despu√©s)
                                const tbody = document.createElement('tbody');
                                const dataRowsAfter = step.tableau_after.slice(0, -1); // Excluir fila Z
                                dataRowsAfter.forEach((row, rowIdx) => {
                                    const tr = document.createElement('tr');
                                    tr.style.backgroundColor = '#ffffff';

                                    const baseCell = document.createElement('td');
                                    baseCell.textContent = step.basis_after[rowIdx];
                                    baseCell.style.padding = '0.4rem';
                                    baseCell.style.border = '1px solid #ddd';
                                    baseCell.style.fontWeight = '600';
                                    tr.appendChild(baseCell);

                                    row.forEach((val, colIdx) => {
                                        const td = document.createElement('td');
                                        td.textContent = formatNumber(val, 4);
                                        td.style.padding = '0.4rem';
                                        td.style.border = '1px solid #ddd';
                                        td.style.textAlign = 'center';
                                        tr.appendChild(td);
                                    });
                                    tbody.appendChild(tr);
                                });

                                // Fila de objetivo
                                const objRow = document.createElement('tr');
                                objRow.style.backgroundColor = '#e0e0ff';
                                const objLabel = document.createElement('td');
                                objLabel.textContent = 'Z';
                                objLabel.style.padding = '0.4rem';
                                objLabel.style.border = '1px solid #ddd';
                                objLabel.style.fontWeight = '600';
                                objRow.appendChild(objLabel);
                                step.obj_row_after.forEach((val, idx) => {
                                    const td = document.createElement('td');
                                    td.textContent = formatNumber(val, 4);
                                    td.style.padding = '0.4rem';
                                    td.style.border = '1px solid #ddd';
                                    td.style.textAlign = 'center';
                                    objRow.appendChild(td);
                                });
                                tbody.appendChild(objRow);

                                afterTable.appendChild(tbody);
                                stepCard.appendChild(afterTable);
                            }

                            stepsContainer.appendChild(stepCard);
                        });
                    } else {
                        const noStepsMsg = document.createElement('div');
                        noStepsMsg.style.padding = '1rem';
                        noStepsMsg.style.color = '#ff6b35';
                        noStepsMsg.textContent = 'No hay pasos disponibles para mostrar.';
                        stepsContainer.appendChild(noStepsMsg);
                    }
                }

                content.appendChild(stepsContainer);
            }

            // Sensibilidad
            if (result.sensitivity_analysis) {
                displaySensitivityAnalysis(result.sensitivity_analysis, result.method);
            }

            // Si es m√©todo gr√°fico, intentar dibujar la gr√°fica ANTES de la tabla
            if (result.method === 'graphical') {
                try {
                    const model = lastAnalysis?.mathematical_model || result.mathematical_model || null;
                    // Graficar cuando Chart.js est√© disponible
                    plotGraphicalSolution(result, model);
                } catch (e) {
                    console.warn('Error preparando gr√°fica:', e);
                }
            }

            // Puntos factibles (tabla de v√©rtices)
            if (result.feasible_points && result.feasible_points.length > 0) {
                const pTitle = document.createElement('div');
                pTitle.className = 'section-title';
                pTitle.textContent = `Evaluaci√≥n de V√©rtices (${result.feasible_points.length} v√©rtices)`;
                content.appendChild(pTitle);

                const wrapper = document.createElement('div');
                wrapper.className = 'table-wrapper';
                const table = document.createElement('table');

                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                ['V√©rtice', 'Coordenada X', 'Coordenada Y', 'Valor Objetivo', 'Estado'].forEach(h => {
                    const th = document.createElement('th');
                    th.textContent = h;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                table.appendChild(thead);

                const tbody = document.createElement('tbody');
                result.feasible_points.forEach((pt, idx) => {
                    const tr = document.createElement('tr');
                    const isOptimal = pt.is_optimal || (result.optimal_point &&
                        result.optimal_point[0] === pt.point[0] &&
                        result.optimal_point[1] === pt.point[1]);

                    if (isOptimal) {
                        tr.style.background = '#fff3e0';
                        tr.style.fontWeight = '600';
                        tr.style.borderLeft = '4px solid #ff9800';
                    }

                    // V√©rtice n√∫mero
                    const numCell = document.createElement('td');
                    numCell.textContent = `V${idx + 1}`;
                    tr.appendChild(numCell);

                    // Coordenada X
                    const xCell = document.createElement('td');
                    xCell.textContent = formatNumber(Number(pt.point[0]), 4);
                    tr.appendChild(xCell);

                    // Coordenada Y
                    const yCell = document.createElement('td');
                    yCell.textContent = formatNumber(Number(pt.point[1]), 4);
                    tr.appendChild(yCell);

                    // Valor Objetivo
                    const objCell = document.createElement('td');
                    objCell.textContent = formatNumber(Number(pt.objective), 6);
                    objCell.style.fontFamily = 'monospace';
                    tr.appendChild(objCell);

                    // Estado
                    const statusCell = document.createElement('td');
                    statusCell.textContent = isOptimal ? '‚òÖ √ìPTIMO' : 'Factible';
                    statusCell.style.color = isOptimal ? '#ff6b35' : '#666';
                    statusCell.style.fontWeight = isOptimal ? '700' : '400';
                    tr.appendChild(statusCell);

                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                wrapper.appendChild(table);

                // Secci√≥n de Soluci√≥n √ìptima
                if (result.optimal_point) {
                    const optimalSection = document.createElement('div');
                    optimalSection.style.marginTop = '1.5rem';
                    optimalSection.style.padding = '1.2rem';
                    optimalSection.style.background = '#fff3e0';
                    optimalSection.style.border = '3px solid #ff9800';
                    optimalSection.style.borderRadius = '8px';
                    optimalSection.style.boxShadow = '0 2px 8px rgba(255, 152, 0, 0.15)';

                    const optimalTitle = document.createElement('div');
                    optimalTitle.style.fontWeight = '700';
                    optimalTitle.style.color = '#ff6b35';
                    optimalTitle.style.marginBottom = '0.8rem';
                    optimalTitle.style.fontSize = '1.2rem';
                    optimalTitle.textContent = '‚òÖ SOLUCI√ìN √ìPTIMA';
                    optimalSection.appendChild(optimalTitle);

                    // Valores de variables
                    const opPoint = Array.isArray(result.optimal_point) ? result.optimal_point : [result.optimal_point[0], result.optimal_point[1]];
                    const varNames = Object.keys(result.variables || {});
                    const varsList = document.createElement('div');
                    varsList.style.marginBottom = '0.8rem';
                    varNames.forEach((varName, idx) => {
                        const valLine = document.createElement('div');
                        valLine.style.marginBottom = '0.3rem';
                        valLine.style.fontSize = '0.95rem';
                        valLine.style.display = 'flex';
                        valLine.style.justifyContent = 'space-between';
                        valLine.style.paddingBottom = '0.3rem';
                        valLine.style.borderBottom = '1px solid rgba(255,152,0,0.1)';
                        valLine.innerHTML = `<strong>${varName}</strong> <span style="font-family: monospace; color: #0066cc;">${formatNumber(Number(opPoint[idx]), 4)}</span>`;
                        varsList.appendChild(valLine);
                    });
                    optimalSection.appendChild(varsList);

                    // Valor √≥ptimo de Z
                    const zLine = document.createElement('div');
                    zLine.style.marginTop = '0.8rem';
                    zLine.style.paddingTop = '0.8rem';
                    zLine.style.borderTop = '2px solid #ff9800';
                    zLine.style.fontWeight = '700';
                    zLine.style.fontSize = '1.15rem';
                    zLine.style.display = 'flex';
                    zLine.style.justifyContent = 'space-between';
                    zLine.innerHTML = `<span>Valor √≥ptimo:</span> <span style="color: #ff6b35; font-size: 1.3rem; font-family: monospace;">Z = ${formatNumber(Number(result.objective_value), 6)}</span>`;
                    optimalSection.appendChild(zLine);

                    wrapper.appendChild(optimalSection);
                }

                content.appendChild(wrapper);
            }

            // Sensibilidad
            if (result.sensitivity) {
                const senTitle = document.createElement('div');
                senTitle.className = 'section-title';
                senTitle.textContent = 'An√°lisis de Sensibilidad';
                content.appendChild(senTitle);

                const senDiv = document.createElement('div');
                senDiv.className = 'sensitivity-section';

                if (result.sensitivity.dual_prices && result.sensitivity.dual_prices.length > 0) {
                    const dp = document.createElement('div');
                    dp.className = 'sensitivity-title';
                    dp.textContent = 'Precios Sombra:';
                    senDiv.appendChild(dp);
                    const dpList = document.createElement('div');
                    dpList.style.marginBottom = '0.8rem';
                    dpList.textContent = result.sensitivity.dual_prices.map(v => formatNumber(v, 4)).join(', ');
                    senDiv.appendChild(dpList);
                }

                if (result.sensitivity.reduced_costs) {
                    const rc = document.createElement('div');
                    rc.className = 'sensitivity-title';
                    rc.textContent = 'Costos Reducidos:';
                    senDiv.appendChild(rc);
                    const rcList = document.createElement('div');
                    rcList.textContent = Object.entries(result.sensitivity.reduced_costs)
                        .map(([k, v]) => `${k}: ${formatNumber(Number(v), 4)}`)
                        .join(', ');
                    senDiv.appendChild(rcList);
                }

                if (result.sensitivity.note) {
                    const note = document.createElement('div');
                    note.style.marginTop = '0.8rem';
                    note.style.fontSize = '0.85rem';
                    note.style.color = '#666';
                    note.style.fontStyle = 'italic';
                    note.textContent = result.sensitivity.note;
                    senDiv.appendChild(note);
                }

                content.appendChild(senDiv);
            }

            // Si es m√©todo gr√°fico, intentar dibujar la gr√°fica
            if (result.method === 'graphical') {
                try {
                    const model = lastAnalysis?.mathematical_model || result.mathematical_model || null;
                    // Graficar cuando Chart.js est√© disponible
                    plotGraphicalSolution(result, model);
                } catch (e) {
                    console.warn('Error preparando gr√°fica:', e);
                }
            }
        }

        // ====================================================================
        // UTILIDADES: Mensajes y gr√°ficos
        // ====================================================================
        function showMessage(text, type) {
            const msgDiv = document.getElementById('message');
            msgDiv.className = `message ${type}`;
            if (type === 'processing') {
                msgDiv.innerHTML = `<span class="spinner"></span>${text}`;
            } else {
                msgDiv.textContent = text;
            }
        }

        // ====================================================================
        // Funci√≥n auxiliar para limpiar decimales
        // ====================================================================
        function formatNumber(num, decimals = 3) {
            if (typeof num !== 'number' || !isFinite(num)) return num;

            // Si todos los decimales son 0, mostrar como entero
            const rounded = Math.round(num * Math.pow(10, decimals)) / Math.pow(10, decimals);
            const str = rounded.toFixed(decimals);
            const decimal = Math.abs(rounded - Math.round(rounded));

            if (decimal < Math.pow(10, -decimals)) {
                return Math.round(rounded).toString();
            }

            // Remover ceros al final
            return str.replace(/\.?0+$/, '');
        }

        // ====================================================================
        function plotGraphicalSolution(result, model) {
            try {
                console.log('plotGraphicalSolution called with', result.feasible_points?.length, 'points');

                // Verificar que Chart.js est√© disponible
                if (!window.Chart) {
                    console.error('Chart.js not available');
                    return;
                }

                const existingContainer = document.getElementById('graphical-plot-container');
                if (existingContainer) existingContainer.remove();

                if (!result || !result.feasible_points || result.feasible_points.length === 0) {
                    console.warn('No feasible points to plot');
                    return;
                }

                // Normalizar puntos factibles a arrays [x,y]
                const pts = result.feasible_points.map(p =>
                    Array.isArray(p.point) ? p.point.map(Number) : [Number(p.point[0]), Number(p.point[1])]
                );

                // Calcular l√≠mites
                const xCoords = pts.map(p => p[0]);
                const yCoords = pts.map(p => p[1]);
                let xMin = Math.min(...xCoords);
                let xMax = Math.max(...xCoords);
                let yMin = Math.min(...yCoords);
                let yMax = Math.max(...yCoords);

                if (!isFinite(xMin) || !isFinite(xMax)) { xMin = -5; xMax = 5; }
                if (!isFinite(yMin) || !isFinite(yMax)) { yMin = -5; yMax = 5; }

                const xRange = xMax - xMin || 1;
                const yRange = yMax - yMin || 1;
                const xPad = xRange * 0.2;
                const yPad = yRange * 0.2;
                xMin -= xPad; xMax += xPad;
                yMin -= yPad; yMax += yPad;

                // Crear contenedor
                const containerDiv = document.createElement('div');
                containerDiv.id = 'graphical-plot-container';
                containerDiv.style.width = '100%';
                containerDiv.style.marginBottom = '1.5rem';
                containerDiv.style.marginTop = '1.5rem';
                containerDiv.style.border = '2px solid #ddd';
                containerDiv.style.borderRadius = '8px';
                containerDiv.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                containerDiv.style.position = 'relative';
                containerDiv.style.height = '550px';

                const canvas = document.createElement('canvas');
                canvas.id = 'graphical-plot';
                containerDiv.appendChild(canvas);
                document.getElementById('solution-content').insertBefore(containerDiv, document.getElementById('solution-content').firstChild.nextSibling.nextSibling.nextSibling);

                // Datos para Chart.js
                const datasets = [];

                // Colores distintos para cada restricci√≥n
                const constraintColors = [
                    '#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd',
                    '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf',
                    '#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd'
                ];

                // Regi√≥n factible (pol√≠gono con sombreado azul) - PRIMERO en datasets para que quede atr√°s
                if (pts.length >= 3) {
                    const center = {
                        x: xCoords.reduce((a, b) => a + b, 0) / xCoords.length,
                        y: yCoords.reduce((a, b) => a + b, 0) / yCoords.length
                    };
                    const angles = pts.map((p, i) => ({
                        idx: i,
                        angle: Math.atan2(p[1] - center.y, p[0] - center.x)
                    })).sort((a, b) => a.angle - b.angle);

                    const polyPoints = angles.map(a => ({
                        x: pts[a.idx][0],
                        y: pts[a.idx][1]
                    }));
                    polyPoints.push(polyPoints[0]); // Cerrar pol√≠gono

                    // Crear dataset de pol√≠gono con muchos puntos intermedios para llenar bien
                    const filledPolyPoints = [];
                    for (let i = 0; i < polyPoints.length - 1; i++) {
                        filledPolyPoints.push(polyPoints[i]);
                        // Interpolar puntos intermedios
                        for (let t = 0.1; t < 1; t += 0.1) {
                            filledPolyPoints.push({
                                x: polyPoints[i].x + t * (polyPoints[i + 1].x - polyPoints[i].x),
                                y: polyPoints[i].y + t * (polyPoints[i + 1].y - polyPoints[i].y)
                            });
                        }
                    }
                    filledPolyPoints.push(polyPoints[polyPoints.length - 1]);

                    datasets.push({
                        label: '',  // Etiqueta vac√≠a para que no aparezca en hover
                        data: filledPolyPoints,
                        borderColor: 'rgba(100,150,200,0.9)',
                        backgroundColor: 'rgba(100,180,255,0.5)',
                        borderWidth: 2.5,
                        fill: true,
                        tension: 0.3,
                        showLine: true,
                        pointRadius: 0,
                        pointHoverRadius: 0,
                        borderDash: [],
                        segment: {
                            borderColor: ctx => 'rgba(100,150,200,0.9)',
                            borderDash: []
                        }
                    });
                }

                // L√≠neas de restricciones con ecuaciones reales
                if (result.constraints_info && result.constraints_info.length > 0) {
                    result.constraints_info.forEach((constraintData, idx) => {
                        try {
                            const a = Number(constraintData.a) || 0;
                            const b = Number(constraintData.b) || 0;
                            const rhs = Number(constraintData.rhs) || 0;

                            // Generar ecuaci√≥n en formato: "ax + by = c"
                            let equationStr = '';
                            if (Math.abs(a) > 1e-12) {
                                const aStr = a === 1 ? 'x' : (a === -1 ? '-x' : `${a.toFixed(2)}x`);
                                equationStr = aStr;
                            }
                            if (Math.abs(b) > 1e-12) {
                                const bStr = b > 0 ? '+' : '';
                                const bVal = b === 1 ? 'y' : (b === -1 ? '-y' : `${b.toFixed(2)}y`);
                                equationStr += (equationStr ? ' ' + bStr + ' ' + bVal : bVal);
                            }
                            equationStr += ` = ${rhs.toFixed(2)}`;

                            const lineColor = constraintColors[idx % constraintColors.length];
                            let linePoints = [];

                            if (Math.abs(b) > 1e-12) {
                                // L√≠nea: y = (rhs - a*x) / b
                                const steps = 200;
                                const step = (xMax - xMin) / steps;
                                for (let x = xMin; x <= xMax; x += step) {
                                    const y = (rhs - a * x) / b;
                                    if (y >= yMin - yPad && y <= yMax + yPad) {
                                        linePoints.push({ x: x.toFixed(2), y: y.toFixed(2) });
                                    }
                                }
                            } else if (Math.abs(a) > 1e-12) {
                                // L√≠nea vertical: x = rhs / a
                                const xv = rhs / a;
                                const steps = 200;
                                const step = (yMax - yMin) / steps;
                                for (let y = yMin; y <= yMax; y += step) {
                                    linePoints.push({ x: xv.toFixed(2), y: y.toFixed(2) });
                                }
                            }

                            if (linePoints.length > 0) {
                                datasets.push({
                                    label: equationStr,
                                    data: linePoints,
                                    borderColor: lineColor,
                                    borderWidth: 2.5,
                                    borderDash: [],
                                    pointRadius: 0,
                                    pointHoverRadius: 0,
                                    fill: false,
                                    tension: 0,
                                    showLine: true,
                                    tooltip: {
                                        callbacks: {
                                            label: () => equationStr
                                        }
                                    }
                                });
                            }
                        } catch (e) {
                            console.warn('Error plotting constraint:', e);
                        }
                    });
                }

                // V√©rtices factibles en negro
                datasets.push({
                    label: 'V√©rtices',
                    data: pts.map((p, i) => ({
                        x: p[0].toFixed(3),
                        y: p[1].toFixed(3),
                        vertexLabel: `V${i + 1}`
                    })),
                    borderColor: '#000000',
                    backgroundColor: '#000000',
                    borderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    showLine: false,
                    fill: false,
                    tooltip: {
                        callbacks: {
                            label: (context) => context.raw.vertexLabel
                        }
                    }
                });

                // Punto √≥ptimo destacado
                if (result.optimal_point) {
                    const op = Array.isArray(result.optimal_point)
                        ? result.optimal_point.map(Number)
                        : [Number(result.optimal_point[0]), Number(result.optimal_point[1])];

                    datasets.push({
                        label: '√ìptimo',
                        data: [{
                            x: op[0].toFixed(3),
                            y: op[1].toFixed(3),
                            optimalLabel: '‚òÖ √ìptimo'
                        }],
                        borderColor: '#cc0000',
                        backgroundColor: '#ff6b35',
                        borderWidth: 3,
                        pointRadius: 12,
                        pointStyle: 'star',
                        pointHoverRadius: 15,
                        showLine: false,
                        fill: false,
                        tooltip: {
                            callbacks: {
                                label: (context) => context.raw.optimalLabel
                            }
                        }
                    });
                }

                // Opciones de Chart.js
                const ctx = canvas.getContext('2d');
                const chart = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    boxWidth: 15,
                                    font: { size: 10 },
                                    padding: 10,
                                    filter: (item) => item.text !== '' // Ocultar etiqueta vac√≠a de regi√≥n factible
                                }
                            },
                            title: {
                                display: true,
                                text: 'Visualizaci√≥n del M√©todo Gr√°fico',
                                font: { size: 18, weight: 'bold' }
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        // Si el dataset tiene tooltip callbacks personalizados, usarlos
                                        if (context.dataset.tooltip?.callbacks?.label) {
                                            return context.dataset.tooltip.callbacks.label(context);
                                        }
                                        return context.dataset.label || '';
                                    }
                                },
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                padding: 12,
                                titleFont: { size: 12 },
                                bodyFont: { size: 11 },
                                displayColors: false
                            }
                        },
                        scales: {
                            x: {
                                type: 'linear',
                                title: {
                                    display: true,
                                    text: 'x',
                                    font: { weight: 'bold', size: 14 }
                                },
                                min: xMin,
                                max: xMax,
                                grid: {
                                    display: true,
                                    drawBorder: true,
                                    color: 'rgba(200,200,200,0.3)'
                                },
                                ticks: {
                                    stepSize: xRange / 10
                                }
                            },
                            y: {
                                type: 'linear',
                                title: {
                                    display: true,
                                    text: 'y',
                                    font: { weight: 'bold', size: 14 }
                                },
                                min: yMin,
                                max: yMax,
                                grid: {
                                    display: true,
                                    drawBorder: true,
                                    color: 'rgba(200,200,200,0.3)'
                                },
                                ticks: {
                                    stepSize: yRange / 10
                                }
                            }
                        }
                    }
                });

                console.log('Chart.js graph created successfully');

            } catch (error) {
                console.error('Error en plotGraphicalSolution:', error);
                const el = document.getElementById('graphical-plot-container');
                if (el) el.remove();
            }
        }

        // ====================================================================
        // AN√ÅLISIS DE SENSIBILIDAD - Visualizaci√≥n Educativa y Did√°ctica
        // ====================================================================
        function displaySensitivityAnalysis(sensitivity, method) {
            console.log('Displaying sensitivity analysis:', sensitivity);
            
            const content = document.getElementById('solution-content');
            
            // Crear contenedor principal
            const container = document.createElement('div');
            container.className = 'sensitivity-analysis-container';
            container.id = 'sensitivity-analysis-section';
            
            // Header
            const header = document.createElement('div');
            header.className = 'sensitivity-header';
            header.innerHTML = `
                <span class="icon">üìä</span>
                <div>
                    <h3>An√°lisis de Sensibilidad Post-√ìptimo</h3>
                    <small style="opacity: 0.9;">M√©todo: ${getMethodDisplayName(method)}</small>
                </div>
            `;
            container.appendChild(header);
            
            // Body
            const body = document.createElement('div');
            body.className = 'sensitivity-body';
            
            // Insights pr√°cticos (arriba de todo)
            if (sensitivity.practical_insights && sensitivity.practical_insights.length > 0) {
                const insightsSection = document.createElement('div');
                insightsSection.className = 'insights-grid';
                sensitivity.practical_insights.forEach(insight => {
                    const card = document.createElement('div');
                    card.className = 'insight-card';
                    card.innerHTML = insight.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    insightsSection.appendChild(card);
                });
                body.appendChild(insightsSection);
            }
            
            // Secci√≥n de teor√≠a expandible
            const theorySection = createTheorySection(sensitivity.theory_explanation);
            body.appendChild(theorySection);
            
            // Tabs de navegaci√≥n
            const tabs = document.createElement('div');
            tabs.className = 'sensitivity-tabs';
            tabs.innerHTML = `
                <button class="sensitivity-tab active" onclick="showSensitivityPanel('objective-ranges', this)">
                    üìà Rangos de Coeficientes
                </button>
                <button class="sensitivity-tab" onclick="showSensitivityPanel('rhs-ranges', this)">
                    üìè Rangos RHS
                </button>
                <button class="sensitivity-tab" onclick="showSensitivityPanel('shadow-prices', this)">
                    üí∞ Precios Sombra
                </button>
                <button class="sensitivity-tab" onclick="showSensitivityPanel('reduced-costs', this)">
                    üìâ Costos Reducidos
                </button>
            `;
            body.appendChild(tabs);
            
            // Paneles
            const panelsContainer = document.createElement('div');
            panelsContainer.id = 'sensitivity-panels';
            
            // Panel 1: Rangos de coeficientes objetivo
            const objectivePanel = createObjectiveRangesPanel(sensitivity.objective_ranges, sensitivity.is_maximization);
            panelsContainer.appendChild(objectivePanel);
            
            // Panel 2: Rangos RHS
            const rhsPanel = createRHSRangesPanel(sensitivity.rhs_ranges);
            panelsContainer.appendChild(rhsPanel);
            
            // Panel 3: Precios sombra
            const shadowPanel = createShadowPricesPanel(sensitivity.shadow_prices, sensitivity.is_maximization);
            panelsContainer.appendChild(shadowPanel);
            
            // Panel 4: Costos reducidos
            const reducedPanel = createReducedCostsPanel(sensitivity.reduced_costs, sensitivity.is_maximization);
            panelsContainer.appendChild(reducedPanel);
            
            body.appendChild(panelsContainer);
            
            // Informaci√≥n de variables b√°sicas/no b√°sicas
            if (sensitivity.basic_variables && sensitivity.non_basic_variables) {
                const varsInfo = document.createElement('div');
                varsInfo.style.marginTop = '1.5rem';
                varsInfo.style.padding = '1rem';
                varsInfo.style.background = '#f8fbff';
                varsInfo.style.borderRadius = '8px';
                varsInfo.style.border = '1px solid #e0e4e8';
                varsInfo.innerHTML = `
                    <div style="font-weight: 700; margin-bottom: 0.5rem; color: #333;">üìã Estado de Variables en la Soluci√≥n √ìptima</div>
                    <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
                        <div>
                            <span style="color: #4caf50; font-weight: 600;">‚úì Variables B√°sicas (en la soluci√≥n):</span>
                            <span style="font-family: monospace; margin-left: 0.5rem;">${sensitivity.basic_variables.join(', ') || 'Ninguna'}</span>
                        </div>
                        <div>
                            <span style="color: #ff9800; font-weight: 600;">‚óã Variables No B√°sicas (valor = 0):</span>
                            <span style="font-family: monospace; margin-left: 0.5rem;">${sensitivity.non_basic_variables.join(', ') || 'Ninguna'}</span>
                        </div>
                    </div>
                `;
                body.appendChild(varsInfo);
            }
            
            container.appendChild(body);
            content.appendChild(container);
            
            // Renderizar MathJax si hay f√≥rmulas
            if (window.MathJax) {
                MathJax.typesetPromise([container]).catch(err => console.warn('MathJax error:', err));
            }
        }
        
        function getMethodDisplayName(method) {
            const names = {
                'simplex': 'Simplex',
                'dual_simplex': 'Simplex Dual',
                'big_m': 'Gran M'
            };
            return names[method] || method;
        }
        
        function showSensitivityPanel(panelId, button) {
            // Desactivar todos los tabs
            document.querySelectorAll('.sensitivity-tab').forEach(tab => tab.classList.remove('active'));
            // Ocultar todos los paneles
            document.querySelectorAll('.sensitivity-panel').forEach(panel => panel.classList.remove('active'));
            
            // Activar tab y panel seleccionados
            button.classList.add('active');
            document.getElementById(panelId).classList.add('active');
        }
        
        function createTheorySection(theoryExplanation) {
            const section = document.createElement('div');
            section.className = 'theory-section';
            
            const header = document.createElement('div');
            header.className = 'theory-header';
            header.innerHTML = `
                <span>üìö ¬øQu√© es el An√°lisis de Sensibilidad? (Click para expandir)</span>
                <span class="theory-toggle">‚ñº</span>
            `;
            
            const content = document.createElement('div');
            content.className = 'theory-content';
            
            // Formatear el contenido de teor√≠a
            if (theoryExplanation) {
                // Convertir Markdown b√°sico a HTML
                let html = theoryExplanation
                    .replace(/## (.*)/g, '<h4>$1</h4>')
                    .replace(/### (.*)/g, '<h4 style="font-size: 1rem;">$1</h4>')
                    .replace(/#### (.*)/g, '<h4 style="font-size: 0.95rem; color: #555;">$1</h4>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n\n/g, '</p><p>')
                    .replace(/- (.*)/g, '<li>$1</li>');
                
                content.innerHTML = `<div style="line-height: 1.7;">${html}</div>`;
            } else {
                content.innerHTML = `
                    <h4>üìñ Fundamentos del An√°lisis de Sensibilidad</h4>
                    <p>El an√°lisis de sensibilidad estudia c√≥mo los cambios en los par√°metros del problema afectan la soluci√≥n √≥ptima. Es fundamental porque:</p>
                    <ul>
                        <li><strong>Los datos raramente son exactos</strong> - hay incertidumbre en costos, disponibilidad de recursos, etc.</li>
                        <li><strong>Permite tomar decisiones m√°s informadas</strong> - sabemos qu√© par√°metros son cr√≠ticos.</li>
                        <li><strong>Identifica oportunidades</strong> - qu√© recursos vale la pena adquirir m√°s.</li>
                    </ul>
                    
                    <h4>üìä Componentes Principales</h4>
                    <ul>
                        <li><strong>Rangos de Optimalidad:</strong> ¬øCu√°nto pueden cambiar los coeficientes de la funci√≥n objetivo sin alterar qu√© variables est√°n en la soluci√≥n?</li>
                        <li><strong>Rangos de Factibilidad:</strong> ¬øCu√°nto pueden variar los recursos disponibles (RHS) manteniendo la base √≥ptima?</li>
                        <li><strong>Precios Sombra:</strong> El valor marginal de cada recurso - ¬øcu√°nto mejorar√≠a Z con una unidad m√°s de cada recurso?</li>
                        <li><strong>Costos Reducidos:</strong> ¬øCu√°nto debe mejorar el coeficiente de una variable no b√°sica para que entre a la soluci√≥n?</li>
                    </ul>
                `;
            }
            
            header.onclick = () => {
                content.classList.toggle('expanded');
                header.querySelector('.theory-toggle').classList.toggle('expanded');
            };
            
            section.appendChild(header);
            section.appendChild(content);
            
            return section;
        }
        
        function createObjectiveRangesPanel(ranges, isMaximization) {
            const panel = document.createElement('div');
            panel.className = 'sensitivity-panel active';
            panel.id = 'objective-ranges';
            
            const title = document.createElement('h4');
            title.style.marginBottom = '1rem';
            title.style.color = '#333';
            title.innerHTML = `üìà Rangos de Optimalidad de Coeficientes <small style="color: #666; font-weight: normal;">(Funci√≥n Objetivo)</small>`;
            panel.appendChild(title);
            
            const explanation = document.createElement('div');
            explanation.style.marginBottom = '1.5rem';
            explanation.style.padding = '1rem';
            explanation.style.background = '#f0f4ff';
            explanation.style.borderRadius = '8px';
            explanation.style.fontSize = '0.9rem';
            explanation.style.lineHeight = '1.6';
            explanation.innerHTML = `
                <strong>¬øQu√© significa esto?</strong><br>
                Estos rangos indican cu√°nto puede variar cada coeficiente $c_j$ de la funci√≥n objetivo 
                sin que cambien las <em>variables b√°sicas</em> (las que tienen valor positivo en la soluci√≥n).
                <br><br>
                <strong>Nota importante:</strong> Aunque la base no cambie, el <em>valor √≥ptimo Z s√≠ cambiar√°</em> 
                proporcionalmente al cambio en el coeficiente.
            `;
            panel.appendChild(explanation);
            
            if (!ranges || ranges.length === 0) {
                panel.innerHTML += '<p style="color: #999;">No hay datos de rangos disponibles.</p>';
                return panel;
            }
            
            // Tabla de rangos
            const tableContainer = document.createElement('div');
            tableContainer.className = 'sensitivity-table-container';
            
            let tableHTML = `
                <table class="sensitivity-table">
                    <thead>
                        <tr>
                            <th>Variable</th>
                            <th>Valor Actual</th>
                            <th>L√≠mite Inferior</th>
                            <th>L√≠mite Superior</th>
                            <th>‚Üì Decremento Permitido</th>
                            <th>‚Üë Incremento Permitido</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            ranges.forEach(range => {
                const currentVal = formatNumber(range.current_value, 4);
                const lowerBound = range.lower_bound_display || formatBound(range.lower_bound);
                const upperBound = range.upper_bound_display || formatBound(range.upper_bound);
                const decrease = range.allowable_decrease_display || formatBound(range.allowable_decrease);
                const increase = range.allowable_increase_display || formatBound(range.allowable_increase);
                
                tableHTML += `
                    <tr>
                        <td><strong style="color: #667eea;">${range.variable}</strong></td>
                        <td style="font-family: monospace; font-weight: 600;">${currentVal}</td>
                        <td style="font-family: monospace; color: ${lowerBound === '-‚àû' ? '#999' : '#d32f2f'};">${lowerBound}</td>
                        <td style="font-family: monospace; color: ${upperBound === '‚àû' ? '#999' : '#388e3c'};">${upperBound}</td>
                        <td style="font-family: monospace;">${decrease}</td>
                        <td style="font-family: monospace;">${increase}</td>
                    </tr>
                    <tr>
                        <td colspan="6" style="background: #fafafa; padding: 0.8rem; font-size: 0.85rem; color: #555;">
                            <div style="margin-bottom: 0.3rem;"><strong>üìù Explicaci√≥n:</strong> ${range.explanation}</div>
                            <div style="color: #667eea;"><strong>üí° Interpretaci√≥n:</strong> ${range.interpretation}</div>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            tableContainer.innerHTML = tableHTML;
            panel.appendChild(tableContainer);
            
            return panel;
        }
        
        function createRHSRangesPanel(ranges) {
            const panel = document.createElement('div');
            panel.className = 'sensitivity-panel';
            panel.id = 'rhs-ranges';
            
            const title = document.createElement('h4');
            title.style.marginBottom = '1rem';
            title.style.color = '#333';
            title.innerHTML = `üìè Rangos de Factibilidad <small style="color: #666; font-weight: normal;">(T√©rminos Independientes RHS)</small>`;
            panel.appendChild(title);
            
            const explanation = document.createElement('div');
            explanation.style.marginBottom = '1.5rem';
            explanation.style.padding = '1rem';
            explanation.style.background = '#f0fff4';
            explanation.style.borderRadius = '8px';
            explanation.style.fontSize = '0.9rem';
            explanation.style.lineHeight = '1.6';
            explanation.innerHTML = `
                <strong>¬øQu√© significa esto?</strong><br>
                Estos rangos indican cu√°nto puede variar cada t√©rmino independiente $b_i$ (lado derecho de las restricciones) 
                manteniendo la misma base √≥ptima.
                <br><br>
                <strong>Importante:</strong> Dentro de estos rangos, los <em>precios sombra permanecen v√°lidos</em> 
                para calcular el cambio en Z.
            `;
            panel.appendChild(explanation);
            
            if (!ranges || ranges.length === 0) {
                panel.innerHTML += '<p style="color: #999;">No hay datos de rangos RHS disponibles.</p>';
                return panel;
            }
            
            // Tabla de rangos
            const tableContainer = document.createElement('div');
            tableContainer.className = 'sensitivity-table-container';
            
            let tableHTML = `
                <table class="sensitivity-table">
                    <thead>
                        <tr>
                            <th>Restricci√≥n</th>
                            <th>RHS Actual</th>
                            <th>L√≠mite Inferior</th>
                            <th>L√≠mite Superior</th>
                            <th>‚Üì Decremento</th>
                            <th>‚Üë Incremento</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            ranges.forEach(range => {
                const currentVal = formatNumber(range.current_value, 4);
                const lowerBound = range.lower_bound_display || formatBound(range.lower_bound);
                const upperBound = range.upper_bound_display || formatBound(range.upper_bound);
                const decrease = range.allowable_decrease_display || formatBound(range.allowable_decrease);
                const increase = range.allowable_increase_display || formatBound(range.allowable_increase);
                
                tableHTML += `
                    <tr>
                        <td><strong style="color: #00aa44;">${range.variable}</strong></td>
                        <td style="font-family: monospace; font-weight: 600;">${currentVal}</td>
                        <td style="font-family: monospace; color: ${lowerBound === '-‚àû' ? '#999' : '#d32f2f'};">${lowerBound}</td>
                        <td style="font-family: monospace; color: ${upperBound === '‚àû' ? '#999' : '#388e3c'};">${upperBound}</td>
                        <td style="font-family: monospace;">${decrease}</td>
                        <td style="font-family: monospace;">${increase}</td>
                    </tr>
                    <tr>
                        <td colspan="6" style="background: #fafafa; padding: 0.8rem; font-size: 0.85rem; color: #555;">
                            <div style="margin-bottom: 0.3rem;"><strong>üìù Explicaci√≥n:</strong> ${range.explanation}</div>
                            <div style="color: #00aa44;"><strong>üí° Interpretaci√≥n:</strong> ${range.interpretation}</div>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            tableContainer.innerHTML = tableHTML;
            panel.appendChild(tableContainer);
            
            return panel;
        }
        
        function createShadowPricesPanel(shadowPrices, isMaximization) {
            const panel = document.createElement('div');
            panel.className = 'sensitivity-panel';
            panel.id = 'shadow-prices';
            
            const title = document.createElement('h4');
            title.style.marginBottom = '1rem';
            title.style.color = '#333';
            title.innerHTML = `üí∞ Precios Sombra <small style="color: #666; font-weight: normal;">(Valores Duales)</small>`;
            panel.appendChild(title);
            
            const explanation = document.createElement('div');
            explanation.style.marginBottom = '1.5rem';
            explanation.style.padding = '1rem';
            explanation.style.background = '#fff8f0';
            explanation.style.borderRadius = '8px';
            explanation.style.fontSize = '0.9rem';
            explanation.style.lineHeight = '1.6';
            explanation.innerHTML = `
                <strong>¬øQu√© es un precio sombra?</strong><br>
                El precio sombra $\\pi_i$ de una restricci√≥n representa el <em>cambio en el valor √≥ptimo Z</em> 
                por cada unidad adicional del recurso $b_i$.
                <br><br>
                <strong>Interpretaci√≥n econ√≥mica:</strong>
                <ul style="margin: 0.5rem 0 0 1.5rem;">
                    <li><strong>Restricci√≥n activa (binding):</strong> El recurso se usa completamente. $\\pi_i > 0$ significa que m√°s recurso mejorar√≠a Z.</li>
                    <li><strong>Restricci√≥n no activa:</strong> Hay excedente del recurso. $\\pi_i = 0$ porque agregar m√°s no ayuda.</li>
                </ul>
            `;
            panel.appendChild(explanation);
            
            if (!shadowPrices || shadowPrices.length === 0) {
                panel.innerHTML += '<p style="color: #999;">No hay datos de precios sombra disponibles.</p>';
                return panel;
            }
            
            // Tarjetas de precios sombra
            const cardsContainer = document.createElement('div');
            
            shadowPrices.forEach(sp => {
                const card = document.createElement('div');
                card.className = `shadow-price-card ${sp.binding ? 'binding' : 'non-binding'}`;
                
                card.innerHTML = `
                    <div class="shadow-price-header">
                        <div>
                            <div class="shadow-price-name">${sp.constraint_name}</div>
                            <span class="shadow-price-badge ${sp.binding ? 'binding' : 'non-binding'}">
                                ${sp.binding ? 'üîí Activa' : 'üîì No Activa'}
                            </span>
                        </div>
                        <div class="shadow-price-value">œÄ = ${formatNumber(sp.value, 4)}</div>
                    </div>
                    <div class="shadow-price-explanation">${sp.explanation}</div>
                    <div class="economic-interpretation">${sp.economic_interpretation}</div>
                `;
                
                cardsContainer.appendChild(card);
            });
            
            panel.appendChild(cardsContainer);
            
            // Resumen visual
            const summaryDiv = document.createElement('div');
            summaryDiv.style.marginTop = '1.5rem';
            summaryDiv.style.padding = '1rem';
            summaryDiv.style.background = '#f5f7fa';
            summaryDiv.style.borderRadius = '8px';
            
            const bindingCount = shadowPrices.filter(sp => sp.binding).length;
            const nonBindingCount = shadowPrices.length - bindingCount;
            const maxShadowPrice = Math.max(...shadowPrices.map(sp => Math.abs(sp.value)));
            const mostValuable = shadowPrices.find(sp => Math.abs(sp.value) === maxShadowPrice);
            
            summaryDiv.innerHTML = `
                <strong>üìä Resumen de Precios Sombra</strong>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 0.8rem;">
                    <div style="background: #d4edda; padding: 0.8rem; border-radius: 6px;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #155724;">${bindingCount}</div>
                        <div style="font-size: 0.85rem; color: #155724;">Restricciones Activas</div>
                    </div>
                    <div style="background: #e2e3e5; padding: 0.8rem; border-radius: 6px;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #383d41;">${nonBindingCount}</div>
                        <div style="font-size: 0.85rem; color: #383d41;">Restricciones con Holgura</div>
                    </div>
                    ${mostValuable && mostValuable.value > 0 ? `
                    <div style="background: #fff3cd; padding: 0.8rem; border-radius: 6px;">
                        <div style="font-size: 1.1rem; font-weight: 700; color: #856404;">${mostValuable.constraint_name}</div>
                        <div style="font-size: 0.85rem; color: #856404;">Recurso M√°s Valioso (œÄ = ${formatNumber(mostValuable.value, 4)})</div>
                    </div>
                    ` : ''}
                </div>
            `;
            
            panel.appendChild(summaryDiv);
            
            return panel;
        }
        
        function createReducedCostsPanel(reducedCosts, isMaximization) {
            const panel = document.createElement('div');
            panel.className = 'sensitivity-panel';
            panel.id = 'reduced-costs';
            
            const title = document.createElement('h4');
            title.style.marginBottom = '1rem';
            title.style.color = '#333';
            title.innerHTML = `üìâ Costos Reducidos <small style="color: #666; font-weight: normal;">(Coeficientes de la Fila Z)</small>`;
            panel.appendChild(title);
            
            const explanation = document.createElement('div');
            explanation.style.marginBottom = '1.5rem';
            explanation.style.padding = '1rem';
            explanation.style.background = '#f5f0ff';
            explanation.style.borderRadius = '8px';
            explanation.style.fontSize = '0.9rem';
            explanation.style.lineHeight = '1.6';
            explanation.innerHTML = `
                <strong>¬øQu√© es el costo reducido?</strong><br>
                El costo reducido $\\bar{c}_j$ indica cu√°nto debe mejorar el coeficiente de una variable 
                para que sea rentable incluirla en la soluci√≥n.
                <br><br>
                <strong>Interpretaci√≥n:</strong>
                <ul style="margin: 0.5rem 0 0 1.5rem;">
                    <li><strong>Variable b√°sica:</strong> Costo reducido = 0 (por definici√≥n, ya est√° en la soluci√≥n).</li>
                    <li><strong>Variable no b√°sica:</strong> El costo reducido muestra el "costo de oportunidad" de incluirla.</li>
                </ul>
            `;
            panel.appendChild(explanation);
            
            if (!reducedCosts || reducedCosts.length === 0) {
                panel.innerHTML += '<p style="color: #999;">No hay datos de costos reducidos disponibles.</p>';
                return panel;
            }
            
            // Grid de tarjetas
            const grid = document.createElement('div');
            grid.className = 'reduced-cost-grid';
            
            reducedCosts.forEach(rc => {
                const card = document.createElement('div');
                card.className = `reduced-cost-card ${rc.is_basic ? 'basic' : 'non-basic'}`;
                
                const isZero = Math.abs(rc.value) < 1e-8;
                
                card.innerHTML = `
                    <div class="reduced-cost-header">
                        <span class="reduced-cost-var">${rc.variable}</span>
                        <span class="reduced-cost-value ${isZero ? 'zero' : 'nonzero'}">${formatNumber(rc.value, 4)}</span>
                    </div>
                    <div class="reduced-cost-status">
                        ${rc.is_basic 
                            ? '‚úÖ <span style="color: #4caf50;">En la base (variable activa)</span>' 
                            : '‚≠ï <span style="color: #ff9800;">Fuera de la base (valor = 0)</span>'}
                    </div>
                    <div class="reduced-cost-interpretation">${rc.interpretation}</div>
                `;
                
                grid.appendChild(card);
            });
            
            panel.appendChild(grid);
            
            return panel;
        }
        
        function formatBound(value) {
            if (value === null || value === undefined) return '‚àû';
            if (value === Infinity || value > 1e10) return '‚àû';
            if (value === -Infinity || value < -1e10) return '-‚àû';
            return formatNumber(value, 4);
        }
    </script>
</body>

</html>